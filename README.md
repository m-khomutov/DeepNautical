# Эмулятор вида из окна на море и программа просмотра

**Сборка**

`git clone https://github.com/m-khomutov/kometa.git`  
`cd kometa/`  
`mkdir build`  
  
Возможные варианты сборки:  
* с использованием toolkit-a Qt  
`.qmake`  
`make all`  
  
* с использованием cmake  
`cd build/`  
`cmake ..`  
`make all`  

**Установка с использованием toolkit-a Qt**  
  
* Файл запуска эмулятора  
  >build/simulator/app/simulator  
* Файл запуска программы просмотра  
  >build/viewer/app/viewer  
  
**Установка с использованием cmake**  
* Файл запуска эмулятора  
  >build/simulator/simulator  
* Файл запуска программы просмотра  
  >build/viewer/viewer  

**Запуск (пример)**
  
* Эмулятор с парамертами  
 `simulator -s ../../../simulator/shaders/ -d 40 -w 800x600 -t ../../../simulator/textures`  
  
* Эмулятор с файлом конфигурации  
 `simulator -c /opt/agat-a/etc/conf`  
  
* Программа просмотрa  
 `viewer -u http://127.0.0.1:2232/`  

**Параметры запуска (выводятся опцией -h)**  

* Эмулятор  
  
```
$ simulator -h  
Вывод опций программы  
Запуск: ./simulator[-h] [-s] [-t] [-p] [-q] [-d] [-w] [-o] [-c] 
  
Эмулятор устройства  
   
обязательные аргументы:  
 	  -s	каталог с шейдерами  
 	  -t	каталог с текстурами  
Опциональные аргументы:  
 	  -p	порт прослушки (def. 2232)  
 	  -w	размеры окна (def. 800x600)  
 	  -q	качество сжатия % (def. 80)  
 	  -d	длительность кадра мс (def. 40)  
 	  -c	файл конфигурации  
 	  -o	каталог с объектами blender  
 	  -h	вывод параметров запуска  
  ```
* Программа просмотрa  
  
```
$ viewer -h  
Вывод опций программы  
Запуск: ./viewer[-h] [-u] [-w] [-v]  
   
программа просмотра  
  
обязательные аргументы:  
 	  -u	url эмулятора  
Опциональные аргументы:  
 	  -w	размеры окна (def. 800x600)  
 	  -v	вывод оценки задержки (def. false)  
 	  -h	вывод параметров запуска  
  ```

**Файл конфигурации**  
  
Каждый параметр занимает строку файла.  
Строки, начинающиеся с символа # игнорируются (являются комментариями).  
Формат строки: ключ=значение, без пробелов, строковые значения в двойных кавычках.  
  
Пример файла:  
```
# Файл конфигурации эмулятора вида на море

shaders="/opt/agat-a/shaders"   # каталог шейдеров
textures="/opt/agat-a/textures" # каталог текстур 
objs="/opt/agat-a/objs"         # каталог объектов, выгруженных из blender-a в формате OBJ
scenes="/opt/agat-a/scenes"     # каталог сцен
port=2232                       # порт приема запросов на трансляцию стрима
window=800x600                  # размеры окна
quality=80                      # качество сжатия %
duration=40                     # длительность кадра мсек.
```
  
**Каталог сцен**  
  
Содержит набор файлов, каждый из которых является спецификацией сцены.  

***Спецификация сцены***  
  
Файл из каталога сцен. Состоит из блоков. Блоки могут повторяться. Каждый блок начинается заголовком в квадратных скобках.  
За заголовком следует набор параметров в формате ключ=значение, без пробелов, строковые значения в двойных кавычках, векторы в фигурных скобках, через пробел.  
Каждый параметр занимает строку файла.  
Строки, начинающиеся с символа # игнорируются (являются комментариями).  
  
Поддерживаются следующие блоки:
* [Horizon]  
  `подложка сцены`

* [Vessel]  
  `фигура корабля`

Пример спецификации с подложкой и одной фигурой корабля:  
```
[Horizon]
shader="horizon.glsl"
texture="56118_Peaceful_ocean_background_HD_BG.avi"

[Vessel]
shader="vessel.glsl"
object="vessel.obj"
# общая скорость движения по сцене
speed={0.00035 -0.00015 0.0}
# точка начала движения по сцене
start_position={-1.2 0.21 0.0}
# длина перемещения по координате х сцены
x_trajectory=2.62
# углы максимального отклонения качки
pitching_angles={15.0 22.0}
# скорость изменения текущего угла качки в процессе движения
pitching_gain=0.1
# фактор размера в начале движения
start_factor={0.05 0.05 0.05}
# скорость изменения фактора в процессе движения
factor_gain=0.00005
```   
  
**Протокол передачи медиа данных**

Используется не совсем стандартный протокол **Flash Video**. Имеются следующие несоответствия стандарту:
* Поддержка кодека JPEG. Стандарт определяет как  
 ` JPEG (currently unused)`
* timestamp передается как 4-х байтная переменная **float**.  
 Определение стандарта
```
Timestamp UI24 
TimestampExtended UI8
```
